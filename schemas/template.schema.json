{
  "$id": "template",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "template",
  "type": "object",
  "properties": {
    "execute_on": {
      "anyOf": [
        { "const": "ve" },
        { "const": "lxc" },
        { "type": "string", "pattern": "^host:.*$" }
      ]
    },
    "skip_if_all_missing": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1,
      "description": "List of parameter IDs. If ALL of these are missing or empty, the template will be skipped. If at least one parameter is present, the template will be executed. If this property is present (and not empty), the template is considered optional."
    },
    "skip_if_property_set": {
      "type": "string",
      "description": "Parameter ID. If this parameter is set (exists in resolvedParams), the template will be skipped."
    },
    "name": {
      "type": "string",
      "maxLength": 30
    },
    "description": {
      "type": "string"
    },
    "parameters": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "id": { "type": "string" },
          "if": { "type": "string" },
          "type": { "enum": ["string", "number", "enum", "boolean"] },
          "description": { "type": "string" },
          "multiline": { "type": "boolean", "default": false },
          "upload": { "type": "boolean", "default": false },
          "required": { "type": "boolean", "default": false },
          "secure": { "type": "boolean", "default": false },
          "advanced": { "type": "boolean", "default": false },
          "default": { "type": ["string", "number", "boolean"] }
        },
        "required": ["name", "id", "type"],
        "if": { "properties": { "type": { "const": "enum" } } },
        "then": {
          "properties": {
            "enumValues": {
              "type": "array",
              "items": { "anyOf": [ { "type": "string" }, { "type": "object", "properties": { "name": { "type": "string" }, "value": { "type": ["string", "number", "boolean"] } } } ] }
            },
            "enumValuesTemplate": {
              "type": "string"
            }
          },
          "anyOf": [
            { "required": ["enumValues"] },
            { "required": ["enumValuesTemplate"] }
          ]
        }
      }
    },
    "commands": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/command" }
    }
  },
  "if": {
    "properties": { "type": { "enum": ["command", "script", "template"] } }
  },
  "then": { "properties": { "enumValues": { "type": "string" } } },
  "required": ["commands", "name"],
  "additionalProperties": false,
  "$defs": {
    "command": {
      "type": "object",
      "properties": {
        "name": { "type": "string", "maxLength": 30 },
        "description": { "type": "string" },
        "command": { "type": "string" },
        "script": { "type": "string" },
        "library": {
          "type": "string",
          "description": "Optional: Path to library file (relative to scripts directory). Library will be prepended to script content."
        },
        "outputs": {
          "type": "array",
          "items": { "$ref": "output.template#" },
          "description": "Expected outputs from this command/script. If outputs are defined here, they will be validated after execution. If outputs are missing, an error will be raised."
        },
        "properties": {
          "description": "Sets parameter values (outputs). If a template has only one command with properties (and no script, command, or template), it is considered a properties-only template and will be displayed as a properties table in documentation. This is the normal case for parameter-setting templates.",
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "value": {
                  "oneOf": [
                    { "type": ["string", "boolean", "number"] },
                    {
                      "type": "array",
                      "items": {
                        "oneOf": [
                          { "type": "string" },
                          {
                            "type": "object",
                            "properties": {
                              "name": { "type": "string" },
                              "value": { "type": ["string", "number", "boolean"] }
                            },
                            "required": ["name", "value"],
                            "additionalProperties": false
                          },
                          {
                            "type": "object",
                            "properties": {
                              "id": { "type": "string" },
                              "value": { "type": ["string", "number", "boolean"] }
                            },
                            "required": ["id", "value"],
                            "additionalProperties": false
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "required": ["id", "value"],
              "additionalProperties": false
            },
            {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "id": { "type": "string" },
                  "value": {
                    "oneOf": [
                      { "type": ["string", "boolean", "number"] },
                      {
                        "type": "array",
                        "items": {
                          "oneOf": [
                            { "type": "string" },
                            {
                              "type": "object",
                              "properties": {
                                "name": { "type": "string" },
                                "value": { "type": ["string", "number", "boolean"] }
                              },
                              "required": ["name", "value"],
                              "additionalProperties": false
                            },
                            {
                              "type": "object",
                              "properties": {
                                "id": { "type": "string" },
                                "value": { "type": ["string", "number", "boolean"] }
                              },
                              "required": ["id", "value"],
                              "additionalProperties": false
                            }
                          ]
                        }
                      }
                    ]
                  }
                },
                "required": ["id", "value"],
                "additionalProperties": false
              }
            }
          ]
        },
        "template": { "type": "string" }
      },
      "oneOf": [
        { "required": ["command"] },
        { "required": ["script"] },
        { "required": ["properties"] },
        { "required": ["template"] }
      ],
      "errorMessage": {
        "oneOf": "Exactly one of 'command', 'script' or 'properties' must be present."
      },
      "additionalProperties": false
    }
  }
}
