{
  "execute_on": "ve",
  "name": "Create and Configure LXC",
  "description": "Creates LXC container and applies optional configurations (templates 101-199).\n\nThis template creates the container and then applies all optional configuration templates in the correct order. Each optional template will be automatically skipped if its required parameters are missing (via skip_if_all_missing).\n\nIf username is provided, a user will be created on the VE host before the container is created (template 095). This ensures consistent UID/GID mapping between host and container.\n\nNote: uid and gid parameters are used for volume permissions only, not for container idmap configuration. The container is created as unprivileged without automatic UID/GID mappings.\n\nTemplates included:\n- 095: Create User on VE Host (if username provided)\n- 100: Create LXC container (unprivileged, no idmap)\n- 104: Compute Static IPs from prefixes\n- 105: Set Static IP for LXC\n- 106: Update /etc/hosts entries\n- 110: Map Serial Device\n- 120: Mount Disk on Host\n- 121: Mount ZFS Pool on Host\n- 160: Bind Multiple Volumes to LXC\n- 170: Set Environment Variables in LXC",
  "parameters": [
    {
      "id": "vm_id",
      "name": "ID of the virtual machine",
      "type": "number",
      "default": "",
      "description": "ID of the virtual machine",
      "advanced": true
    },
    {
      "id": "template_path",
      "name": "Path to the LXC template",
      "type": "string",
      "required": true,
      "description": "Path to the LXC template (e.g. local:vztmpl/alpine-3.19-default_20231107_amd64.tar.xz). Auto-selected by installer for Alpine. Must be provided by 010-get-latest-os-template.json template."
    },
    {
      "id": "oci_image",
      "name": "OCI Image",
      "type": "string",
      "default": "",
      "advanced": true,
      "description": "Optional: OCI image reference used to create the container (e.g. docker://mariadb:11.0.2). If provided, it will be written into the Proxmox notes (description) as an identifiable line."
    },
    {
      "id": "oci_image_tag",
      "name": "OCI Image Tag",
      "type": "string",
      "default": "",
      "advanced": true,
      "description": "Optional: Actual OCI image tag/version that was downloaded (e.g. 0.17.5). If provided, it will be written into the Proxmox notes as Version." 
    },
    {
      "id": "disk_size",
      "name": "Disk size",
      "type": "string",
      "default": "4",
      "description": "Disk size for the container in GB",
      "advanced": true
    },
    {
      "id": "memory",
      "name": "Memory in MB",
      "type": "number",
      "default": 512,
      "description": "Memory for the container in MB",
      "advanced": true
    },
    {
      "id": "bridge",
      "name": "Network bridge",
      "type": "string",
      "default": "vmbr0",
      "description": "Network bridge to use",
      "advanced": true
    },
    {
      "id": "hostname",
      "name": "Hostname",
      "required": true,
      "type": "string",
      "description": "Hostname for the LXC container"
    },
    {
      "id": "uid",
      "name": "UID",
      "type": "string",
      "default": "0",
      "description": "UID for UID/GID mapping and permissions. If provided, will be mapped directly between host and container (1:1 mapping). Default is 0 (root).",
      "advanced": true
    },
    {
      "id": "gid",
      "name": "GID",
      "type": "string",
      "default": "0",
      "description": "GID for UID/GID mapping and permissions. If provided, will be mapped directly between host and container (1:1 mapping). Default is 0 (root).",
      "advanced": true
    },
    {
      "id": "username",
      "name": "Username",
      "type": "string",
      "default": "root",
      "description": "Optional: Username to create on the VE host before container creation. This ensures consistent UID/GID mapping between host and container. Default is root. If not provided, root will be used.",
      "advanced": true
    }
  ],
  "commands": [

    {
      "name": "Create LXC container",
      "script": "create-lxc-container.sh",
      "outputs": ["vm_id"]
    },    
    {
      "name": "Setup UID mapping",
      "script": "setup-lxc-uid-mapping.py",
      "library": "setup_lxc_idmap_common.py"
    },
    {
      "name": "Setup GID mapping",
      "script": "setup-lxc-gid-mapping.py",
      "library": "setup_lxc_idmap_common.py"
    },
    {
      "name": "Compute Static IPs",
      "template": "104-lxc-static-ip-prefix.json"
    },
    {
      "name": "Set Static IP for LXC",
      "template": "105-set-static-ip-for-lxc.json"
    },
    {
      "name": "Update /etc/hosts entries",
      "template": "106-update-etc-hosts-on-ve.json"
    },
    {
      "name": "Map Serial Device",
      "template": "110-map-serial.json"
    },
    {
      "name": "Mount Disk on Host",
      "template": "120-mount-disk-on-host.json"
    },
    {
      "name": "Mount ZFS Pool on Host",
      "template": "121-mount-zfs-pool-on-host.json"
    },
    {
      "name": "Bind Multiple Volumes to LXC",
      "template": "160-bind-multiple-volumes-to-lxc.json"
    },
    {
      "name": "Set Env Variables in LXC",
      "template": "170-set-environment-variables-in-lxc.json"
    }
  ]
}



