{
  "name": "Assign a free GPU to a VM",
  "description": "This script automatically assigns a free GPU (PCI device) to a specified Proxmox VM. It ensures that only GPUs not currently used by the host (i.e., not enabled in the kernel parameters) or by other VMs are considered. The script is idempotent, robust, and safe for production use.\n\nHow it works:\n- Detects all available PCI GPUs on the host.\n- Excludes GPUs already assigned to other VMs (by checking all /etc/pve/qemu-server/*.conf files for hostpci entries).\n- Excludes GPUs still in use by the host (i.e., not disabled via kernel parameters such as video=<output>:d in /etc/default/grub).\n- Selects the first truly free GPU and assigns it to the specified VM using the next available hostpci slot.\n- If the VM is running, it is stopped before assignment and restarted afterwards.\n- All error messages and status outputs are sent to stderr.\n\nTemplate variable:\n- {{ vm_id }}: The numeric ID of the Proxmox VM to which the GPU should be assigned.\n\nUsage notes:\n- This script is intended for environments where GPU passthrough is required and device assignment must be automated and safe.\n- It is suitable for use in orchestration pipelines and as part of automated deployment workflows.\n- The script assumes that the order of GPUs in lspci matches the order of video outputs in kernel parameters, which is usually but not always the case.\n- Always review the assignment after running in new hardware environments.\n\nExample usage:\n  VMID=101 ./assign-free-gpu-to-vm.sh\n  # or via template system with {{ vm_id }} replaced automatically\n",
  "execute_on": "ve",
  "commands": [
    {
      "script": "assign-free-gpu-to-vm.sh"
    }
  ],
  "parameters": [
    {
      "id": "vm_id",
      "type": "number",
      "name": "ID of the VM",
      "description": "The numeric ID of the Proxmox VM.",
      "required": true
    }
  ]
}
