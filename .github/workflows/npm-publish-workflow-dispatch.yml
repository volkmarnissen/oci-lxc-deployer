name: Build and publish Docker image from npm pack

#
# This workflow builds the project, creates an npm pack tarball and
# builds & pushes a Docker image to GHCR.
on:
  workflow_dispatch:
    inputs:
      version_number:
        description: Version number <patch|minor| version number(E.g. 1.0.0) see npm version> An empty version number doesn't change the version
        default: ''

# Defines two custom environment variables for the workflow. These are used for the Container registry domain, and a name for the Docker image that this workflow builds.
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: modbus2mqtt/lxc-manager

jobs:
  docker_image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: set-version
        run: |
          set -euo pipefail
          git config --global user.email "noreply@carcam360.de" 
          git config --global user.name "Workflow User"
          if [ -n "${{ inputs.version_number }}" ]; then
            version="$(npm version ${{ inputs.version_number }} | sed -e 's/^v//g' )"
            git push --follow-tags
          else
            version="$(node -p \"require('./package.json').version\")"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          # Check if this is a major or minor release (patch number is 0)
          if [[ "$version" =~ \.0$ ]]; then
            echo "isRelease=true" >> $GITHUB_OUTPUT
          else
            echo "isRelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Build project and create npm pack tarball
        id: pack
        run: |
          set -euo pipefail
          npm ci
          echo "::group::Building project frontend ..."
          (cd frontend && npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Building backend  ..."
          (cd backend && npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Building root  ..."
          (npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Packing npm tarball ..."
          info=$(npm pack --json)
          tarball=$(node -e "const i=JSON.parse(process.env.INFO); console.log(i[0].filename)" INFO="$info")
          version=$(node -e "const i=JSON.parse(process.env.INFO); console.log(i[0].version)" INFO="$info")
          mv "$tarball" docker/lxc-manager.tgz
          echo "tarball=docker/lxc-manager.tgz" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image from npm pack
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.npm-pack
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/lxc-manager:${{ steps.pack.outputs.version }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/lxc-manager:latest
          build-args: |
            NPM_TARBALL=${{ steps.pack.outputs.tarball }}
            BUILD_VERSION=${{ steps.pack.outputs.version }}
            BUILD_REF=${{ github.sha }}
            BUILD_DATE=${{ github.run_started_at }}
            BUILD_REPOSITORY=${{ github.repository }}

      - name: Create GitHub Release (for major/minor releases)
        if: steps.set-version.outputs.isRelease == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.pack.outputs.version }}
          name: Release v${{ steps.pack.outputs.version }}
          body: |
            ## Release v${{ steps.pack.outputs.version }}
            
            For installation instructions and documentation, please see the [README.md](https://github.com/${{ github.repository }}/blob/v${{ steps.pack.outputs.version }}/README.md).
            
            ### Docker Image
            The Docker image is available at:
            - `${{ env.REGISTRY }}/${{ github.repository_owner }}/lxc-manager:${{ steps.pack.outputs.version }}`
            - `${{ env.REGISTRY }}/${{ github.repository_owner }}/lxc-manager:latest`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
