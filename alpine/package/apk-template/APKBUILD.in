# shellcheck shell=sh 
pkgname=@PKGNAME@
pkgver=@PKGVER@
pkgrel=@PKGREL@
pkgdesc="@PKGDESC@"
url="@URL@"
arch="noarch"
license="@LICENSE@"
depends="@DEPENDS@ openssh-client-default openssh-keygen"
makedepends="@MAKEDEPENDS@"
install="$pkgname.pre-install $pkgname.post-install $pkgname.post-upgrade"
options="!check !strip"
source="
    files/service.initd
    files/service.confd
    files/pre-install
    files/post-install
    "
builddir="$srcdir/$pkgname-$pkgver"
npmpackage="@NPMPACKAGE@"
POST_INSTALL_EXTRA='@POST_INSTALL_EXTRA@'
POST_NPM_SCRIPT='@POST_NPM_SCRIPT@'

prepare() {
    # No-op: all files are pre-rendered by generate-ap.sh
    :
}

build() {
    mkdir -p "$builddir"
    cd "$builddir" || exit 1
    npm init -y >/dev/null 2>&1 || true
    npmpackagev="${npmpackage}@${pkgver}"
    echo "Installing ${npmpackagev}..."
    npm_log=$(mktemp)
    if ! npm install --force --no-audit --no-fund --omit=dev "${npmpackagev}" >"$npm_log" 2>&1; then
        echo "ERROR: npm install failed for ${npmpackagev}" >&2
        cat "$npm_log" >&2
        rm -f "$npm_log"
        exit 1
    else
      echo "npm install done " >&2
    fi
    rm -f "$npm_log"
        if [ -n "$POST_NPM_SCRIPT" ]; then
            echo "Executing post-npm script: $startdir/$POST_NPM_SCRIPT" >&2
            if [ -f "$startdir/$POST_NPM_SCRIPT" ]; then
                sh "$startdir/$POST_NPM_SCRIPT" "$builddir"
            else
                echo "WARNING: Post-npm script not found: $startdir/$POST_NPM_SCRIPT" >&2
            fi
        fi
}

package() {
    install -d "$pkgdir"/usr/lib/$pkgname
    mkdir -p "$pkgdir"/usr/lib
    rsync -au "$builddir"/node_modules "$pkgdir"/usr/lib
        # Remove prebuilt binaries to reduce package size
        if [ -d "$pkgdir/usr/lib/node_modules" ]; then
            find "$pkgdir/usr/lib/node_modules" -type d -name prebuilds -exec rm -rf {} \; 2>/dev/null || true
        fi
    install -d "$pkgdir"/usr/bin
    ln -s /usr/lib/node_modules/$npmpackage/bin/$pkgname "$pkgdir"/usr/bin/$pkgname
    install -d "$pkgdir"/etc/$pkgname
    install -d -m 755 "$pkgdir"/config
    install -d -m 755 "$pkgdir"/data
    install -d -m 755 "$pkgdir"/ssl
    install -m755 -D "$startdir"/files/service.initd "$pkgdir"/etc/init.d/$pkgname
    install -m644 -D "$startdir"/files/service.confd "$pkgdir"/etc/conf.d/$pkgname
    # Create runtime directory inside package; ownership set in maintainer scripts
    install -d -m 755 "$pkgdir"/var/lib/@PKGNAME@
    # install -d -m700 /root/.ssh
}
sha512sums=""
